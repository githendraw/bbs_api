<!DOCTYPE html>
<html>
<head>
    <title>Print Resi</title>
    <style type="text/css">
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @page {
            size: A4;
            margin: 5mm;
        }

        @media print {
            @page {
                size: A4;
                margin: 5mm;
            }
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            font-size: 8pt;
            color: #000;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .page-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5mm;
        }

        .receipt {
            border: 1px solid #000;
            padding: 1.5mm;
            page-break-inside: avoid;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
        }

        table td, table th {
            border: 1px solid #000;
            padding: 1px 3px;
            vertical-align: middle;
        }

        .no-border td, .no-border th {
            border: none;
        }

        .label {
            font-weight: bold;
            font-size: 7pt;
        }

        .text-center {
            text-align: center;
        }

        .logo-img {
            width: auto;
            height: 32px;
            display: block;
        }

        .company-title {
            font-size: 9pt;
            font-weight: bold;
            text-align: center;
        }

        .company-subtitle {
            font-size: 7pt;
            text-align: center;
            line-height: 1.1;
        }

        .company-address {
            font-size: 6pt;
            text-align: center;
            line-height: 1.0;
        }

        .total-row {
            background-color: #ddd !important;
            font-weight: bold;
        }

        .remarks-section {
            border: 1px solid #000;
            padding: 1px;
            font-size: 7pt;
            font-weight: bold;
            text-align: center;
            background-color: #ffffcc !important;
        }

        .footer-info {
            font-size: 6pt;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <% for(var j=0; j < 3; j++) {%>
        <div class="receipt">
            <!-- Header -->
            <table class="no-border" style="margin-bottom: 1px;">
                <tr>
                    <td style="width: 20%; text-align: center;">
                        <img class="logo-img" src="data:image/png;base64,<%=img%>">
                    </td>
                    <td style="width: 55%;">
                        <div class="company-title">PAKET EXPRESS</div>
                        <div class="company-subtitle">CARGO DAN LOGISTICS SERVICES - KE SELURUH INDONESIA</div>
                        <div class="company-subtitle">Jemput Antar Alamat (Door to Door)</div>
                        <div class="company-address"><%=company.address1%> | WA: <%=company.phone_1%></div>
                    </td>
                    <td style="width: 25%; vertical-align: bottom; text-align: right;">
                        <div style="font-size: 9pt; font-weight: bold; color: #000;">ISI TIDAK DIPERIKSA</div>
                    </td>
                </tr>
            </table>

            <!-- Main Details Table -->
            <table style="margin-bottom: 1px;">
                <tr>
                    <td class="label">No.AWB</td>
                    <td><%=shipment.shipment_awbm%></td>
                    <td class="label">Asal</td>
                    <td><%=shipment.originname%></td>
                    <td class="label">Tujuan</td>
                    <td><%=shipment.destinationname%></td>
                    <td class="label">Koli</td>
                    <td style="width: 6%;"><%=shipment.qty%></td>
                    <td class="label">Berat</td>
                    <td style="width: 7%;"><%=shipment.weight_actual%></td>
                    <td class="label">Vol</td>
                    <td style="width: 7%;"><%=shipment.weight_vol%></td>
                </tr>
            </table>

            <!-- Pengirim & Penerima Info -->
            <table style="margin-bottom: 1px;">
                <tr>
                    <td style="width: 8%;" class="label">Pelanggan</td>
                    <td colspan="5"><%=shipment.partner_name%></td>
                    <td style="width: 10%;" class="label">Penerima</td>
                    <td colspan="5"><%=shipment.receiver_name%></td>
                </tr>
                <tr>
                    <td class="label">Telp</td>
                    <td colspan="5"><%=shipment.partner_phone1%></td>
                    <td class="label">Telp</td>
                    <td colspan="5"><%=shipment.receiver_phone1%></td>
                </tr>
                <tr>
                    <td class="label">Alamat</td>
                    <td colspan="5"><%=shipment.partner_address1%></td>
                    <td class="label">Alamat</td>
                    <td colspan="5"><%=shipment.receiver_address1%></td>
                </tr>
            </table>

            <!-- Service & Payment Info -->
            <table style="margin-bottom: 1px;">
                <tr>
                    <td style="width: 12%;" class="label">Jenis</td>
                    <td style="width: 15%;"><%=shipment.shipment_type_id || 'DARAT'%></td>
                    <td style="width: 10%;" class="label">Via</td>
                    <td style="width: 15%;"><%=shipment.service_id%></td>
                    <td style="width: 8%;" class="label">Tgl</td>
                    <td style="width: 40%;"><%=moment(shipment.shipment_date).format('DD-MM-YYYY')%></td>
                </tr>
                <tr>
                    <td class="label">Barang</td>
                    <td colspan="5"><%=shipment.itemdesc%></td>
                </tr>
            </table>

            <!-- Cost Breakdown -->
            <table style="margin-bottom: 1px;">
                <tr>
                    <td style="width: 25%;" class="label">Biaya Kirim</td>
                    <td style="width: 25%;">Rp <%=currencyFormatter.format(shipment.charge, {code: 'IDR'}).replace('Rp', '')%></td>
                    <% if (shipment.tax_amount > 0) { %>
                    <td style="width: 25%;" class="label">PPh 23</td>
                    <td style="width: 25%;">(Rp <%=currencyFormatter.format(shipment.tax_amount, {code: 'IDR'}).replace('Rp', '')%>)</td>
                    <% } else { %>
                    <td style="width: 25%;" class="label">Lain-lain</td>
                    <td style="width: 25%;">Rp <%=currencyFormatter.format(shipment.pickup_charge || 0, {code: 'IDR'}).replace('Rp', '')%></td>
                    <% } %>
                </tr>
                <tr>
                    <td class="label">Asuransi</td>
                    <td>Rp <%=currencyFormatter.format(shipment.insurance || 0, {code: 'IDR'}).replace('Rp', '')%></td>
                    <td class="label">Admin</td>
                    <td>Rp <%=currencyFormatter.format(shipment.packing_charge || 0, {code: 'IDR'}).replace('Rp', '')%></td>
                </tr>
                <tr class="total-row">
                    <td class="label">Total</td>
                    <td>Rp <%=currencyFormatter.format(shipment.total, {code: 'IDR'}).replace('Rp', '')%></td>
                    <td class="label">Bayar</td>
                    <td><%=shipment.payment_type || 'TRANSFER'%></td>
                </tr>
            </table>

            <!-- Remarks -->
            <div class="remarks-section" style="margin-bottom: 1px;">
                <%=shipment.specialinst || 'TANPA ASURANSI'%> | TLG JGN DIBANTING/DITINDIH BARANG BERAT
            </div>

            <!-- Footer with Signature -->
            <table style="margin-bottom: 1px;">
                <tr>
                    <td style="width: 30%;" class="text-center">
                        <div style="font-size: 8pt;">Tanda Tangan Pengirim</div>
                    </td>
                    <td style="width: 5%;"></td>
                    <td style="width: 30%;" class="text-center">
                        <div style="font-size: 8pt;">Tanda Tangan Petugas</div>
                        <div style="font-size: 7pt;"><%=shipment.pickup_by%></div>
                    </td>
                    <td style="width: 35%;" class="text-center">
                        <div style="font-size: 8pt;">Tanda Tangan & Stempel</div>
                    </td>
                </tr>
            </table>

            <!-- Bottom Section -->
            <table class="no-border" style="margin-bottom: 1px;">
                <tr>
                    <td style="width: 45%;" class="text-center">
                        <div style="font-size: 8pt;">Nama</div>
                    </td>
                    <td style="width: 15%;" class="text-center">
                        <div style="font-size: 8pt;">Tanggal</div>
                    </td>
                    <td style="width: 40%;" class="text-center">
                        <div id="qrcode-<%=j%>" style="display: inline-block;"></div>
                    </td>
                </tr>
            </table>

            <!-- Disclaimer & Footer Info -->
            <table class="no-border">
                <tr>
                    <td style="width: 75%;" class="text-center">
                        <div style="font-size: 7pt; font-weight: bold;">Kiriman ini sudah saya/kami terima dengan baik dan benar</div>
                        <div style="font-size: 6pt;">Pengirim menyatakan bahwa semua informasi pada Surat Tanda Terima Titipan adalah BENAR</div>
                    </td>
                    <td style="width: 25%;" class="text-center">
                        <div style="font-size: 8pt;">Jam</div>
                    </td>
                </tr>
            </table>

            <!-- Print Info -->
            <div style="display: flex; justify-content: space-between; margin-top: 1px;" class="footer-info">
                <span><%=moment().format('DD-MM-YYYY HH:mm')%></span>
                <span>File <%=j+1%> = <%=j === 0 ? 'PENGIRIM' : j === 1 ? 'PUKET' : 'PENERIMA'%></span>
            </div>
        </div>
        <% } %>
    </div>

    <!-- QRCode Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <script>
        // Generate QR Code
        <% for(var j=0; j < 3; j++) {%>
            new QRCode(document.getElementById("qrcode-<%=j%>"), {
                text: "<%=shipment.shipment_awbm%>",
                width: 40,
                height: 40,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });
        <% } %>

        // Auto print after 1 second, then close tab
        setTimeout(function() {
            window.print();
            // Close tab after print dialog is closed (user prints or cancels)
            window.addEventListener('afterprint', function() {
                window.close();
            });
            // Fallback: close after 1 second if afterprint doesn't fire
            setTimeout(function() {
                window.close();
            }, 1000);
        }, 1000);
    </script>
</body>
</html>
